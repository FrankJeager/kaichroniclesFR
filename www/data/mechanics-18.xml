<?xml version="1.0" encoding="utf-8"?>

<mechanics book="18" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="https://raw.githubusercontent.com/cracrayol/kaichronicles/master/www/data/mechanics.xsd">

    <!-- GAME RULES -->
    <sections>

        <section id="tssf">
            <!-- Restore the endurance to the maximum -->
            <endurance count="+[MAXENDURANCE]" />
            <!-- Drop the previous books map -->
            <drop objectId="map" />
            <!-- Restore Deliverance use each X days -->
            <restoreDeliveranceUse />
        </section>

        <section id="gamerulz">
            <!-- Select the player skills (weapons skill and endurance) UI -->
            <setSkills />
        </section>

        <section id="discplnz">
            <!-- Select the Kai disciplines UI -->
            <setDisciplines />
        </section>

        <section id="equipmnt" pickMaximum="4">
            <!-- Do not pick 2 maps! -->
            <test not="true" hasObject="map">
                <pick objectId="map" />
            </test>
            <test not="true" hasObject="backpack">
                <pick objectId="backpack" />
            </test>

            <randomTable>
                <pick class="money" count="[RANDOM] + 20" excessToKaiMonastry="true" />
            </randomTable>

            <!-- Kai monastery safekeeping -->
            <kaiMonasteryStorage />

            <object objectId="quarterstaff" />
            <object objectId="bow" />
            <object objectId="quiver" count="6" />
            <object objectId="dagger" />
            <object objectId="sword" />
            <object objectId="meal" index="0" />
            <object objectId="meal" index="1" />
            <object objectId="rope" />
            <object objectId="laumspurpotion4" />
            <object objectId="axe" />

            <chooseEquipment text="Click on the Random Table link to get money before continuing" />
            <message text="You may take up to four of the following (all meals count as one object):" />
        </section>

        <section id="sect3">
            <choiceState section="sect283" set="disabled" />
            <test hasObject="silverseal">
                <choiceState section="sect283" set="enabled" />
                <choiceState section="sect317" set="disabled" />
            </test>
        </section>

        <section id="sect9">
            <choiceState section="all" set="disabled" />
            <combat noMindblast="true" noPsiSurge="true" />
            <afterCombats>
                <choiceState section="sect89" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect10">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case to="2">
                    <choiceState section="sect258" set="enabled" />
                </case>
                <case from="3">
                    <choiceState section="sect134" set="enabled" />
                </case>
            </randomTable>
            <test hasDiscipline="hntmstry">
                <randomTableIncrement increment="+3" />
            </test>
            <test hasDiscipline="nexus">
                <randomTableIncrement increment="+2" />
            </test>
            <test hasDiscipline="pthmnshp">
                <randomTableIncrement increment="+1" />
            </test>
            <test expression="[ENDURANCE] &lt;= 11">
                <randomTableIncrement increment="-1" />
            </test>
        </section>

        <section id="sect13">
            <endurance count="-1" />
        </section>

        <section id="sect14">
            <object objectId="sword" />
            <object objectId="rope" />
            <object objectId="tinderbox" />
            <object objectId="blanket" />
            <object objectId="bow" />
            <object objectId="quiver" count="5" />
            <object objectId="spyglass" />
            <pick class="money" count="12" currency="lune" />
            <meal />
        </section>

        <section id="sect15">
            <choiceState section="sect221" set="disabled" />
            <test hasDiscipline="kaiscrn">
                <choiceState section="sect221" set="enabled" />
                <choiceState section="sect99" set="disabled" />
            </test>
        </section>

        <section id="sect16">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case to="1">
                    <choiceState section="sect278" set="enabled" />
                </case>
                <case from="2" to="6">
                    <choiceState section="sect183" set="enabled" />
                </case>
                <case from="7">
                    <choiceState section="sect107" set="enabled" />
                </case>
            </randomTable>
        </section>

        <section id="sect19">
            <endurance count="+3" />
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case to="6">
                    <choiceState section="sect81" set="enabled" />
                </case>
                <case from="7">
                    <choiceState section="sect229" set="enabled" />
                </case>
            </randomTable>
        </section>

        <section id="sect21">
            <death />
        </section>

        <section id="sect22">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case to="3">
                    <choiceState section="sect310" set="enabled" />
                </case>
                <case from="4">
                    <choiceState section="sect105" set="enabled" />
                </case>
            </randomTable>
        </section>

        <section id="sect23">
            <choiceState section="sect113" set="disabled" />
            <test hasObject="oedeherb|oedejar|mathopotion">
                <choiceState section="sect113" set="enabled" />
                <choiceState section="sect128" set="disabled" />
            </test>
        </section>

        <section id="sect25">
            <choiceState section="sect221" set="disabled" />
            <test hasDiscipline="kaiscrn">
                <choiceState section="sect221" set="enabled" />
                <choiceState section="sect99" set="disabled" />
            </test>
        </section>

        <section id="sect26">
            <choiceState section="all" set="disabled" />
            <combat />
            <afterCombats>
                <choiceState section="sect199" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect27">
            <endurance count="-2" />
        </section>

        <section id="sect28">
            <onInventoryEvent>
                <test expression="[MONEY-ON-SECTION] == 5 || ([BACKPACK-ITEMS-CNT-ON-SECTION] == 1 &amp;&amp; [MONEY] &lt; 5) || [BACKPACK-ITEMS-CNT-ON-ACTIONCHART] == 0">
                    <choiceState section="sect319" set="enabled" />
                </test>
                <test not="true" expression="[MONEY-ON-SECTION] == 5 || ([BACKPACK-ITEMS-CNT-ON-SECTION] == 1 &amp;&amp; [MONEY] &lt; 5) || [BACKPACK-ITEMS-CNT-ON-ACTIONCHART] == 0">
                    <message id="b18s28" text="Please drop 5 gold crown or one backpack item if not enough money." />
                    <choiceState section="sect319" set="disabled" />
                </test>
            </onInventoryEvent>
        </section>

        <section id="sect29">
            <endurance count="-3" />
        </section>

        <section id="sect30">
            <choiceState section="sect232" set="disabled" />
            <test expression="[ENDURANCE] &lt;= 10">
                <choiceState section="sect232" set="enabled" />
                <choiceState section="sect177" set="disabled" />
            </test>
        </section>

        <section id="sect33">
            <choiceState section="all" set="disabled" />
            <combat />
            <afterCombats>
                <test not="true" expression="[COMBATSDURATION] >= 4">
                    <choiceState section="sect85" set="enabled" />
                </test>
                <test expression="[COMBATSDURATION] >= 4">
                    <choiceState section="sect160" set="enabled" />
                </test>
            </afterCombats>
        </section>

        <section id="sect34">
            <endurance count="-4" />
            <test not="true" hasObject="platinumamulet|ishirtalisman" hasDiscipline="nexus">
                <endurance count="-3" />
            </test>
        </section>

        <section id="sect39">
            <choiceState section="all" set="disabled" />
            <combat />
            <test hasObject="jewelledmace">
                <combat combatSkillModifier="+3" />
            </test>
            <afterCombats>
                <choiceState section="sect146" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect40">
            <choiceState section="sect291" set="disabled" />
            <test hasDiscipline="pthmnshp">
                <test hasDiscipline="gnosis">
                    <choiceState section="sect291" set="enabled" />
                    <choiceState section="sect127" set="disabled" />
                </test>
            </test>
        </section>

        <section id="sect41">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case to="2">
                    <choiceState section="sect21" set="enabled" />
                </case>
                <case from="3">
                    <choiceState section="sect230" set="enabled" />
                </case>
            </randomTable>
            <test hasDiscipline="gnosis">
                <test expression="[KAILEVEL] >= 7">
                    <randomTableIncrement increment="+2" />
                </test>
            </test>
            <test hasDiscipline="hntmstry">
                <randomTableIncrement increment="+2" />
            </test>
            <test hasDiscipline="anmlmstr">
                <randomTableIncrement increment="+1" />
            </test>
        </section>

        <section id="sect42">
            <pick class="money" count="-3" />
        </section>

        <section id="sect43">
            <meal />
        </section>

        <section id="sect44">
            <choiceState section="sect252" set="disabled" />
            <test hasDiscipline="gnosis">
                <choiceState section="sect252" set="enabled" />
                <choiceState section="sect124" set="disabled" />
            </test>
        </section>

        <section id="sect46">
            <test not="true" hasObject="platinumamulet|ishirtalisman" hasDiscipline="nexus">
                <endurance count="-3" />
            </test>
        </section>

        <section id="sect50">
            <choiceState section="all" set="disabled" />
            <combat eludeTurn="4" />
            <afterCombats>
                <choiceState section="sect290" set="enabled" />
            </afterCombats>
            <afterElude>
                <choiceState section="sect335" set="enabled" />
            </afterElude>
        </section>

        <section id="sect51">
            <endurance count="+[MAXENDURANCE]" />
        </section>

        <section id="sect52">
            <choiceState section="all" set="disabled" />
            <endurance count="-4" />
            <combat />
            <afterCombats>
                <choiceState section="sect93" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect53">
            <death />
        </section>

        <section id="sect56">
            <choiceState section="sect284" set="disabled" />
            <test hasTag="varetta">
                <choiceState section="sect284" set="enabled" />
                <choiceState section="sect62" set="disabled" />
            </test>
        </section>

        <section id="sect57">
            <choiceState section="all" set="disabled" />
            <combat />
            <afterCombats>
                <choiceState section="sect324" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect58">
            <choiceState section="all" set="disabled" />
            <combat />
            <afterCombats>
                <choiceState section="sect49" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect59">
            <endurance count="+3" />
        </section>

        <section id="sect63">
            <choiceState section="all" set="disabled" />
            <combat eludeTurn="4" />
            <afterCombats>
                <choiceState section="sect109" set="enabled" />
            </afterCombats>
            <afterElude>
                <choiceState section="sect182" set="enabled" />
            </afterElude>
        </section>

        <section id="sect64">
            <drop objectId="suncrystal" />
            <choiceState section="sect321" set="disabled" />
            <choiceState section="sect208" set="disabled" />
            <choiceState section="sect18" set="disabled" />
            <test hasDiscipline="nexus">
                <choiceState section="sect321" set="enabled" />
                <choiceState section="sect131" set="disabled" />
            </test>
            <test hasObject="platinumamulet">
                <choiceState section="sect321" set="enabled" />
                <choiceState section="sect131" set="disabled" />
            </test>
            <test hasObject="ishirtalisman">
                <choiceState section="sect321" set="enabled" />
                <choiceState section="sect131" set="disabled" />
            </test>
        </section>

        <section id="sect65">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case to="3">
                    <choiceState section="sect53" set="enabled" />
                </case>
                <case from="4">
                    <choiceState section="sect298" set="enabled" />
                </case>
            </randomTable>
            <test hasDiscipline="assimila">
                <randomTableIncrement increment="+2" />
            </test>
            <test hasDiscipline="pthmnshp">
                <randomTableIncrement increment="+1" />
            </test>
        </section>

        <section id="sect69">
            <choiceState section="sect305" set="disabled" />
            <test hasDiscipline="nexus">
                <test expression="[KAILEVEL] >= 9">
                    <choiceState section="sect187" set="enabled" />
                    <choiceState section="sect305" set="disabled" />
                </test>
            </test>
        </section>

        <section id="sect70">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case to="5">
                    <choiceState section="sect163" set="enabled" />
                </case>
                <case from="6">
                    <choiceState section="sect125" set="enabled" />
                </case>
            </randomTable>
        </section>

        <section id="sect72">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case to="4">
                    <choiceState section="sect219" set="enabled" />
                </case>
                <case from="5">
                    <choiceState section="sect301" set="enabled" />
                </case>
            </randomTable>
        </section>

        <section id="sect73">
            <choiceState section="all" set="disabled" />
            <combat noMindblast="true" noPsiSurge="true" />
            <afterCombats>
                <choiceState section="sect295" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect75">
            <choiceState section="sect234" set="disabled" />
            <test expression="[MONEY] >= 5">
                <choiceState section="sect234" set="enabled" />
                <choiceState section="sect259" set="disabled" />
            </test>
        </section>

        <section id="sect76">
            <pick class="arrow" count="-1" />
            <test not="true" hasObject="platinumamulet|ishirtalisman" hasDiscipline="nexus">
                <endurance count="-3" />
            </test>
        </section>

        <section id="sect80">
            <test canUseBow="false">
                <choiceState section="sect196" set="disabled" />
            </test>
        </section>

        <section id="sect83">
            <meal />
        </section>

        <section id="sect85">
            <object objectId="sword" />
            <object objectId="rope" />
            <object objectId="tinderbox" />
            <object objectId="blanket" />
            <object objectId="bow" />
            <object objectId="quiver" count="5" />
            <object objectId="spyglass" />
            <pick class="money" count="12" currency="lune" />
            <meal />
        </section>

        <section id="sect87">
            <endurance count="-5" />
        </section>

        <section id="sect88">
            <endurance count="-3" />
        </section>

        <section id="sect89">
            <object objectId="luthadagger" />
            <onInventoryEvent>
                <test hasObject="luthadagger">
                    <choiceState section="sect150" set="enabled" />
                </test>
                <test not="true" hasObject="luthadagger">
                    <choiceState section="sect150" set="disabled" />
                </test>
            </onInventoryEvent>
        </section>

        <section id="sect90">
            <choiceState section="sect348" set="disabled" />
            <test hasTag="varetta|raiderroadhut|tahou|vorndarol">
                <choiceState section="sect348" set="enabled" />
                <choiceState section="sect184" set="disabled" />
            </test>
        </section>

        <section id="sect92">
            <pick class="money" count="5" />
            <meal />
        </section>

        <section id="sect93">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case to="2">
                    <choiceState section="sect21" set="enabled" />
                </case>
                <case from="3">
                    <choiceState section="sect230" set="enabled" />
                </case>
            </randomTable>
            <test hasDiscipline="gnosis">
                <test expression="[KAILEVEL] >= 7">
                    <randomTableIncrement increment="+2" />
                </test>
            </test>
            <test hasDiscipline="hntmstry">
                <randomTableIncrement increment="+2" />
            </test>
            <test hasDiscipline="anmlmstr">
                <randomTableIncrement increment="+1" />
            </test>
        </section>

        <section id="sect94">
            <choiceState section="sect203" set="disabled" />
            <test hasDiscipline="hntmstry">
                <test expression="[KAILEVEL] >= 7">
                    <choiceState section="sect203" set="enabled" />
                    <choiceState section="sect151" set="disabled" />
                </test>
            </test>
        </section>

        <section id="sect95">
            <endurance count="-4" />
        </section>

        <section id="sect97">
            <pick class="money" count="-2" />
        </section>

        <section id="sect98">
            <choiceState section="all" set="disabled" />
            <currentWeapon objectId="sommerswerd" />
            <combat noMindblast="true" noPsiSurge="true" combatSkillModifier="+4" />
            <afterCombats>
                <choiceState section="sect288" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect100">
            <object objectId="suncrystal" />
            <onInventoryEvent>
                <test hasObject="suncrystal">
                    <choiceState section="sect323" set="enabled" />
                </test>
                <test not="true" hasObject="suncrystal">
                    <choiceState section="sect323" set="disabled" />
                </test>
            </onInventoryEvent>
        </section>

        <section id="sect101">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case to="4">
                    <choiceState section="sect219" set="enabled" />
                </case>
                <case from="5">
                    <choiceState section="sect301" set="enabled" />
                </case>
            </randomTable>
        </section>

        <section id="sect103">
            <pick class="money" count="-2" />
            <endurance count="+3" />
        </section>

        <section id="sect106">
            <endurance count="-4" />
        </section>

        <section id="sect107">
            <choiceState section="all" set="disabled" />
            <combat />
            <afterCombats>
                <choiceState section="sect285" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect108">
            <choiceState section="sect247" set="disabled" />
            <test hasDiscipline="nexus">
                <test expression="[KAILEVEL] >= 9">
                    <choiceState section="sect247" set="enabled" />
                    <choiceState section="sect88" set="disabled" />
                </test>
            </test>
        </section>

        <section id="sect109">
            <pick class="money" count="65" />
            <object objectId="sword" index="1" />
            <object objectId="sword" index="2" />
            <object objectId="axe" index="1" />
            <object objectId="axe" index="2" />
            <object objectId="broadsword" />
            <object objectId="spear" index="1" />
            <object objectId="spear" index="2" />
            <object objectId="backpack" />
            <object objectId="meal" index="1" />
            <object objectId="meal" index="2" />
            <object objectId="meal" index="1" />
            <object objectId="meal" index="2" />
            <object objectId="meal" index="3" />
            <object objectId="meal" index="4" />
            <object objectId="meal" index="5" />
            <object objectId="meal" index="6" />
            <object objectId="meal" index="7" />
            <object objectId="meal" index="8" />
            <object objectId="meal" index="9" />
            <object objectId="meal" index="10" />
            <object objectId="rope" />
            <object objectId="boarwhip" />
            <object objectId="hammer" />
            <object objectId="lantern" />
            <object objectId="blanket" />
            <object objectId="spyglass" />
            <object objectId="silverseal" />
        </section>

        <section id="sect110">
            <object objectId="sword" />
            <object objectId="rope" />
            <object objectId="tinderbox" />
            <object objectId="blanket" />
            <object objectId="bow" />
            <object objectId="quiver" count="5" />
            <object objectId="spyglass" />
            <pick class="money" count="3" />
            <meal />
        </section>

        <section id="sect112">
            <choiceState section="sect348" set="disabled" />
            <test hasTag="varetta|raiderroadhut|tahou|vorndarol">
                <choiceState section="sect348" set="enabled" />
                <choiceState section="sect184" set="disabled" />
            </test>
        </section>

        <section id="sect113">
            <endurance count="-6" />
            <use objectId="oedeherb|oedejar|mathopotion" applyEffect="false" />
        </section>

        <section id="sect114">
            <test canUseBow="false">
                <choiceState section="sect192" set="disabled" />
            </test>
        </section>

        <section id="sect116">
            <choiceState section="sect47" set="disabled" />
            <test hasDiscipline="anmlmstr">
                <choiceState section="sect47" set="enabled" />
                <choiceState section="sect156" set="disabled" />
            </test>
        </section>

        <section id="sect117">
            <death />
        </section>

        <section id="sect118">
            <object objectId="silverseal" />
        </section>

        <section id="sect120">
            <choiceState section="sect101" set="disabled" />
            <test hasObject="sommerswerd">
                <choiceState section="sect101" set="enabled" />
                <choiceState section="sect72" set="disabled" />
            </test>
        </section>

        <section id="sect121">
            <choiceState section="sect204" set="disabled" />
            <test hasTag="cearmaine">
                <choiceState section="sect204" set="enabled" />
                <choiceState section="sect84" set="disabled" />
            </test>
        </section>

        <section id="sect122">
            <choiceState section="sect46" set="disabled" />
            <test hasDiscipline="alchemy">
                <choiceState section="sect46" set="enabled" />
                <choiceState section="sect153" set="disabled" />
            </test>
        </section>

        <section id="sect125">
            <choiceState section="sect47" set="disabled" />
            <test hasDiscipline="anmlmstr">
                <choiceState section="sect47" set="enabled" />
                <choiceState section="sect156" set="disabled" />
            </test>
        </section>

    </sections>
</mechanics>