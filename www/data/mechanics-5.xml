<?xml version="1.0" encoding="utf-8"?>

<mechanics book="5">

    <!-- LIST OF TRANSLATED IMAGES -->
    <translated-images>
        <image>map.png</image>
        <image>weapons.png</image>
    </translated-images>

    <!-- GAME RULES -->
    <sections>

        <section id="tssf">
            <!-- Restore the endurace to the maximum -->
            <endurance count="+[MAXENDURANCE]" />
            <!-- Drop the previous books map -->
            <drop objectId="map" />
        </section>

        <section id="gamerulz">
            <!-- Select the player skills (weapons skill and endurance) UI -->
            <setSkills />
        </section>

        <section id="discplnz">
            <!-- Select the Kai disciplines UI -->
            <setDisciplines />
        </section>

        <section id="equipmnt">
            <!-- Do not pick 2 maps! -->
            <test not="true" hasObject="map" >
                <pick objectId="map" />
            </test>

            <randomTable>
                <pick class="money" count="[RANDOM] + 10" />
            </randomTable>

            <object objectId="dagger" />
            <object objectId="laumspurpotion4" />
            <object objectId="sword" />
            <object objectId="spear" />
            <object objectId="meal" index="0" />
            <object objectId="meal" index="1" />
            <object objectId="mace" />
            <object objectId="shield" />

            <chooseEquipment 
                en-text="Pick the money and choose up to four objects before continue" 
                es-text="Escoge el dinero y elige hasta cuatro objetos antes de continuar"
            />
        </section>

        <section id="sect1" en-text="Part I" es-text="Parte I" >
        </section>

        <section id="sect2">
            <!-- TODO: Restore temporal CS loss -->
            <object objectId="oedeherb" />
        </section>

        <section id="sect3">
            <pick class="money" count="4" />
            <object objectId="dagger" />
            <object objectId="sword" />
            <object objectId="potionofstrength" />
            <object objectId="blowpipe" />
            <object objectId="sleepdart" />
        </section>

        <section id="sect4">
            <choiceState section="all" set="disabled" />
            <afterCombats>
                <test not="true" expression="[COMBATSDURATION] >= 5">
                    <choiceState section="sect165" set="enabled" />
                </test>
                <test expression="[COMBATSDURATION] >= 5">
                    <choiceState section="sect180" set="enabled" />
                </test>
            </afterCombats>
        </section>

        <section id="sect5">
            <death />
        </section>

        <section id="sect8">
            <endurance count="-2" />
        </section>

        <section id="sect10">
            <saveInventoryState restorePoint="book4sect10Inventory" />
            <drop objectId="all" />
        </section>

        <section id="sect11">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case from="-2" to="2">
                    <choiceState section="sect167" set="enabled" />
                </case>
                <case from="3" to="9">
                    <choiceState section="sect190" set="enabled" />
                </case>
            </randomTable>
            <test hasDiscipline="camflage|hunting">
                <randomTableIncrement increment="-2" />
            </test>
        </section>

        <section id="sect12">
            <choiceState section="all" set="disabled" />
            <combat index="0" combatSkillModifier="-2" noMindblast="true" />
            <afterCombats>
                <choiceState section="all" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect13">
            <test not="true" hasDiscipline="anmlknsp">
                <choiceState section="sect187" set="disabled" />
            </test>
            <test hasDiscipline="anmlknsp">
                <choiceState section="sect110" set="disabled" />
            </test>
        </section>

        <section id="sect14">
            <restoreInventoryState restorePoint="book4sect10Inventory" />
        </section>

        <section id="sect15">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case from="-1" to="7">
                    <choiceState section="sect151" set="enabled" />
                </case>
                <case from="8" to="9">
                    <choiceState section="sect175" set="enabled" />
                </case>
            </randomTable>
            <test hasDiscipline="hunting" expression="[KAILEVEL] >= 7">
                <randomTableIncrement increment="-1" />
            </test>
        </section>

        <section id="sect16">
            <object objectId="rope" />
            <object objectId="tinderbox" />
        </section>

        <section id="sect17">
            <test not="true" hasDiscipline="sixthsns" >
                <choiceState section="sect47" set="disabled" />
            </test>
        </section>

        <section id="sect18">
            <death />
        </section>

        <section id="sect19">
            <!-- TODO: Meals right now are considered as backpack items. Wrong -->
            <message id="msg-drop-objects" 
                en-text="Drop the Backpack Items you want to give to the guards" 
                es-text="Deja los Objetos de Mochila que quieres dar a los guardias"
            />
            <onInventoryEvent>
                <test expression="[BACKPACK-ITEMS-CNT-ON-SECTION] >= 2">
                    <message id="msg-drop-objects" op="hide" />
                    <choiceState section="sect137" set="enabled" />
                    <choiceState section="sect49" set="disabled" />
                </test>
                <test not="true" expression="[BACKPACK-ITEMS-CNT-ON-SECTION] >= 2">
                    <message id="msg-drop-objects" op="show" />
                    <choiceState section="sect137" set="disabled" />
                    <choiceState section="sect49" set="enabled" />
                </test>
            </onInventoryEvent>
        </section>

        <section id="sect20">
            <choiceState section="all" set="disabled" />
            <combat eludeTurn="0" fake="true" restoreFactor="0.5" />
            <afterCombats>
                <test combatsWon="true">
                    <test not="true" expression="[COMBATSDURATION] >= 4">
                    <choiceState section="sect125" set="enabled" />
                    </test>
                    <test expression="[COMBATSDURATION] >= 4">
                        <choiceState section="sect82" set="enabled" />
                    </test>
                </test>
                <test combatsWon="false">
                    <choiceState section="sect161" set="enabled" />
                </test>
            </afterCombats>
            <afterElude>
                <choiceState section="sect142" set="enabled" />
                <choiceState section="sect176" set="enabled" />
            </afterElude>
        </section>

        <!-- Up to sect14 -->

    </sections>

</mechanics>