<?xml version="1.0" encoding="utf-8"?>

<mechanics book="5">

    <!-- LIST OF TRANSLATED IMAGES -->
    <translated-images>
        <image>map.png</image>
        <image>weapons.png</image>
    </translated-images>

    <!-- GAME RULES -->
    <sections>

        <section id="tssf">
            <!-- Restore the endurace to the maximum -->
            <endurance count="+[MAXENDURANCE]" />
            <!-- Drop the previous books map -->
            <drop objectId="map" />
        </section>

        <section id="gamerulz">
            <!-- Select the player skills (weapons skill and endurance) UI -->
            <setSkills />
        </section>

        <section id="discplnz">
            <!-- Select the Kai disciplines UI -->
            <setDisciplines />
        </section>

        <section id="equipmnt">
            <!-- Do not pick 2 maps! -->
            <test not="true" hasObject="map" >
                <pick objectId="map" />
            </test>

            <randomTable>
                <pick class="money" count="[RANDOM] + 10" />
            </randomTable>

            <object objectId="dagger" />
            <object objectId="laumspurpotion4" />
            <object objectId="sword" />
            <object objectId="spear" />
            <object objectId="meal" index="0" />
            <object objectId="meal" index="1" />
            <object objectId="mace" />
            <object objectId="shield" />

            <chooseEquipment 
                en-text="Pick the money and choose up to four objects before continue" 
                es-text="Escoge el dinero y elige hasta cuatro objetos antes de continuar"
            />
        </section>

        <section id="sect1" en-text="Part I" es-text="Parte I" >
        </section>

        <section id="sect2">
            <!-- TODO: Restore temporal CS loss -->
            <object objectId="oedeherb" />
        </section>

        <section id="sect3">
            <pick class="money" count="4" />
            <object objectId="dagger" />
            <object objectId="sword" />
            <object objectId="potionofstrength" />
            <object objectId="blowpipe" />
            <object objectId="sleepdart" />
        </section>

        <section id="sect4">
            <choiceState section="all" set="disabled" />
            <afterCombats>
                <test not="true" expression="[COMBATSDURATION] >= 5">
                    <choiceState section="sect165" set="enabled" />
                </test>
                <test expression="[COMBATSDURATION] >= 5">
                    <choiceState section="sect180" set="enabled" />
                </test>
            </afterCombats>
        </section>

        <section id="sect5">
            <death />
        </section>

        <section id="sect8">
            <endurance count="-2" />
        </section>

        <section id="sect10">
            <saveInventoryState restorePoint="book4sect10Inventory" />
            <drop objectId="all" />
        </section>

        <section id="sect11">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case from="-2" to="2">
                    <choiceState section="sect167" set="enabled" />
                </case>
                <case from="3" to="9">
                    <choiceState section="sect190" set="enabled" />
                </case>
            </randomTable>
            <test hasDiscipline="camflage|hunting">
                <randomTableIncrement increment="-2" />
            </test>
        </section>

        <section id="sect12">
            <choiceState section="all" set="disabled" />
            <combat index="0" combatSkillModifier="-2" noMindblast="true" />
            <afterCombats>
                <choiceState section="all" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect13">
            <test not="true" hasDiscipline="anmlknsp">
                <choiceState section="sect187" set="disabled" />
            </test>
            <test hasDiscipline="anmlknsp">
                <choiceState section="sect110" set="disabled" />
            </test>
        </section>

        <section id="sect14">
            <restoreInventoryState restorePoint="book4sect10Inventory" />
        </section>

        <section id="sect15">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case from="-1" to="7">
                    <choiceState section="sect151" set="enabled" />
                </case>
                <case from="8" to="9">
                    <choiceState section="sect175" set="enabled" />
                </case>
            </randomTable>
            <test expression="[KAILEVEL] >= 7">
                <randomTableIncrement increment="-1" />
            </test>
        </section>

        <section id="sect16">
            <object objectId="rope" />
            <object objectId="tinderbox" />
        </section>

        <section id="sect17">
            <test not="true" hasDiscipline="sixthsns" >
                <choiceState section="sect47" set="disabled" />
            </test>
        </section>

        <section id="sect18">
            <death />
        </section>

        <section id="sect19">
            <!-- TODO: Meals right now are considered as backpack items. Wrong -->
            <message id="msg-drop-objects" 
                en-text="Drop the Backpack Items you want to give to the guards" 
                es-text="Deja los Objetos de Mochila que quieres dar a los guardias"
            />
            <onInventoryEvent>
                <test expression="[BACKPACK-ITEMS-CNT-ON-SECTION] >= 2">
                    <message id="msg-drop-objects" op="hide" />
                    <choiceState section="sect137" set="enabled" />
                    <choiceState section="sect49" set="disabled" />
                </test>
                <test not="true" expression="[BACKPACK-ITEMS-CNT-ON-SECTION] >= 2">
                    <message id="msg-drop-objects" op="show" />
                    <choiceState section="sect137" set="disabled" />
                    <choiceState section="sect49" set="enabled" />
                </test>
            </onInventoryEvent>
        </section>

        <section id="sect20">
            <choiceState section="all" set="disabled" />
            <combat eludeTurn="0" fake="true" restoreFactor="0.5" />
            <afterCombats>
                <test combatsWon="true">
                    <test not="true" expression="[COMBATSDURATION] >= 4">
                    <choiceState section="sect125" set="enabled" />
                    </test>
                    <test expression="[COMBATSDURATION] >= 4">
                        <choiceState section="sect82" set="enabled" />
                    </test>
                </test>
                <test combatsWon="false">
                    <choiceState section="sect161" set="enabled" />
                </test>
            </afterCombats>
            <afterElude>
                <choiceState section="sect142" set="enabled" />
                <choiceState section="sect176" set="enabled" />
            </afterElude>
        </section>

        <section id="sect22">
            <endurance count="-8" />
            <test not="true" hasDiscipline="healing">
                <choiceState section="sect107" set="disabled" />
            </test>
            <test hasDiscipline="healing">
                <choiceState section="sect63" set="disabled" />
            </test>
        </section>

        <section id="sect23">
            <choiceState section="all" set="disabled" />
            <!-- TODO: If you have lost an arm use??? -->
            <randomTable>
                <case from="-3" to="-1">
                    <choiceState section="sect77" set="enabled" />
                </case>
                <case from="0" to="6">
                    <choiceState section="sect192" set="enabled" />
                </case>
                <case from="7" to="11">
                    <choiceState section="sect114" set="enabled" />
                </case>
            </randomTable>
            <test hasDiscipline="hunting">
                <randomTableIncrement increment="+2" />
            </test>
        </section>

        <section id="sect24">
            <test not="true" hasDiscipline="sixthsns" >
                <choiceState section="sect147" set="disabled" />
            </test>
            <test hasDiscipline="sixthsns" >
                <choiceState section="sect196" set="disabled" />
            </test>
        </section>

        <section id="sect26">
            <test not="true" hasDiscipline="mindomtr" >
                <choiceState section="sect48" set="disabled" />
            </test>
        </section>

        <section id="sect27">
            <object objectId="larnumaoil" price="3" unlimited="true" />
            <object objectId="laumspurpotion4" price="5" unlimited="true" />
            <object objectId="rendalimelixir" price="7" unlimited="true" />
        </section>

        <section id="sect29">
            <drop objectId="rope" />
        </section>

        <section id="sect30">
            <test not="true" expression="[KAILEVEL] >= 7">
                <choiceState section="sect62" set="disabled" />
            </test>
        </section>

        <section id="sect31">
            <test hasObject="firesphere|tinderbox">
                <choiceState section="sect183" set="disabled" />
            </test>
            <test not="true" hasObject="firesphere|tinderbox">
                <choiceState section="sect143" set="disabled" />
            </test>
        </section>

        <section id="sect34">
            <endurance count="-1" />
        </section>

        <section id="sect35">
            <object objectId="jewelledmace" />
            <object objectId="copperkey" />
        </section>

        <section id="sect38">
            <endurance count="-1" />
        </section>

        <section id="sect40">
            <pick class="money" count="-[MONEY]" />
            <endurance count="-2" />
            <message id="msg-drop-object" 
                en-text="Drop one Backpack Item before continue" 
                es-text="Deja un Objeto de Mochila antes de continuar" 
            />
            <choiceState section="all" set="disabled" />
            <onInventoryEvent>
                <test expression="[BACKPACK-ITEMS-CNT-ON-ACTIONCHART] == 0 || [BACKPACK-ITEMS-CNT-ON-SECTION] >= 1">
                    <message id="msg-drop-object" op="hide" />
                    <choiceState section="all" set="enabled" />
                </test>
                <test not="true" expression="[BACKPACK-ITEMS-CNT-ON-ACTIONCHART] == 0 || [BACKPACK-ITEMS-CNT-ON-SECTION] >= 1">
                    <message id="msg-drop-object" op="show" />
                    <choiceState section="all" set="disabled" />
                </test>
            </onInventoryEvent>
        </section>

        <section id="sect46">
            <choiceState section="all" set="disabled" />
            <afterCombats>
                <choiceState section="all" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect48">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case from="0" to="4">
                    <choiceState section="sect34" set="enabled" />
                </case>
                <case from="5" to="99">
                    <choiceState section="sect80" set="enabled" />
                </case>
            </randomTable>
            <test expression="[KAILEVEL] >= 7">
                <randomTableIncrement increment="+3" />
            </test>
        </section>

        <section id="sect49">
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case from="0" to="5">
                    <choiceState section="sect106" set="enabled" />
                </case>
                <case from="6" to="13">
                    <choiceState section="sect189" set="enabled" />
                </case>
            </randomTable>
            <test hasDiscipline="hunting">
                <randomTableIncrement increment="+1" />
            </test>
            <test expression="[KAILEVEL] >= 9">
                <randomTableIncrement increment="+3" />
            </test>
        </section>

        <section id="sect50">
            <endurance count="-2" />
        </section>

        <section id="sect51">
            <endurance count="-1" />
            <test not="true" hasDiscipline="tracking" >
                <choiceState section="sect173" set="disabled" />
            </test>
        </section>

        <section id="sect52">
            <pick class="money" count="4" />
            <object objectId="gaolerkeys" />
            <object objectId="dagger" />
            <object objectId="sword" />
        </section>

        <section id="sect54">
            <!-- TODO: If you need the Oede herb ??? -->
        </section>

        <section id="sect56">
            <object objectId="jakan" />
            <choiceState section="all" set="disabled" />
            <randomTable>
                <case from="0" to="3">
                    <choiceState section="sect7" set="enabled" />
                </case>
                <case from="4" to="11">
                    <choiceState section="sect28" set="enabled" />
                </case>
            </randomTable>
            <test hasDiscipline="wepnskll">
                <randomTableIncrement increment="+2" />
            </test>
        </section>

        <section id="sect57">
            <!-- TODO: If you have ever fought an Elix before, add 2 to your COMBAT SKILL 
                for the duration of this fight -->
            <choiceState section="all" set="disabled" />
            <afterCombats>
                <choiceState section="all" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect58">
            <!-- TODO: If you know the correct number that will open the bronze door, 
                 turn to that section number. Right nuber is 67 -->
            <test bookLanguage="en">
                <choiceState section="sect98" set="disabled" />
            </test>
            <numberPicker 
                en-text="Choose the number for the Cloeasian combination lock"
                es-text="Elige el número para la cerradura"
                min="1" max="200" 
                en-actionButton="Choose"
                es-actionButton="Elige"
                />
            <!--onNumberPickerChoosed>
                <test expression="[NUMBERPICKER] == 67">
                    <goToSection section="sect67" />
                </test>
                <test expression="[NUMBERPICKER] != 67">
                    <toast 
                        es-text="Wrong number!"
                        en-text="¡Número incorrecto!" />
                    <goToSection section="sect156" />
                </test>
            </onNumberPickerChoosed-->
        </section>

        <section id="sect59">
            <choiceSelected section="sect4">                
                <pick objectId="sword" />
            </choiceSelected>
        </section>

        <section id="sect63">
            <!-- Player will lose 2 E.P. each section until a Laumspur Potion is used -->
            <registerGlobalRule id="book5sect63">
                <objectUsed objectId="laumspurpotion|laumspurpotion4|redpotionlaumspur">
                    <unregisterGlobalRule id="book5sect63" />
                </objectUsed>
                <choiceSelected section="all">                
                    <endurance count="-2" />
                </choiceSelected>
            </registerGlobalRule>
        </section>

        <section id="sect64">
            <choiceState section="all" set="disabled" />
            <combat mindblastBonus="+4" />
            <afterCombats>
                <choiceState section="all" set="enabled" />
            </afterCombats>
        </section>

        <section id="sect67">
            <object objectId="quarterstaff" />
        </section>

        <!-- Up to sect67 -->

    </sections>

</mechanics>